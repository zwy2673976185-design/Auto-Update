<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>悬浮窗+自动更新（最终稳定版）</title>
    <style>
        /* 主体内容容器 */
        #latest-html-container {
            width: 100%; height: 100vh; overflow-y: auto; position: absolute; top: 0; left: 0;
            z-index: 1; background: #f5f5f5;
        }
        /* 更新提示 */
        #update-notice {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: #2563eb; color: #fff; border-radius: 6px;
            z-index: 99; display: none;
        }
        /* 悬浮球 */
        .float-btn {
            position: fixed; right: 20px; bottom: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: url(https://i.imgs.ovh/2025/09/28/75fraO.jpeg) no-repeat center;
            background-size: cover; border: none; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1002;
        }
        /* 悬浮窗 */
        .float-window {
            position: fixed; right: 20px; bottom: 100px;
            width: 280px; height: 250px; background: #fff;
            border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            display: none; z-index: 1001;
        }
        .float-window.active { display: block; }
        /* 悬浮窗头部 */
        .window-header {
            padding: 12px 15px; background: #2563eb; color: #fff;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-back {
            background: transparent; border: none; color: #fff;
            font-size: 18px; cursor: pointer;
        }
        /* 功能按钮区 */
        .func-buttons {
            padding: 10px; height: calc(100% - 42px); overflow-y: auto;
        }
        .func-btn {
            display: block; width: 100%; padding: 10px; margin: 8px 0;
            border: none; border-radius: 6px; background: #f8f9fa;
            text-align: left; font-size: 14px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="latest-html-container">
        <div style="height: 100%; display: flex; align-items: center; justify-content: center;">
            <p style="font-size: 16px; color: #666;">加载最新内容中...</p>
        </div>
    </div>
    <div id="update-notice">已更新到最新文件</div>

    <button class="float-btn" id="floatBtn"></button>
    <div class="float-window" id="floatWindow">
        <div class="window-header">
            功能面板
            <button class="modal-back" id="modalBack">×</button>
        </div>
        <div class="func-buttons">
            <button class="func-btn" id="btnMy">我的</button>
            <button class="func-btn" id="btnNotice">公告</button>
            <button class="func-btn" id="btnContact">联系作者</button>
            <button class="func-btn" id="btnSetting">设置</button>
        </div>
    </div>

    <script>
        // 悬浮窗核心交互
        const floatBtn = document.getElementById('floatBtn');
        const floatWindow = document.getElementById('floatWindow');
        const modalBack = document.getElementById('modalBack');

        floatBtn.addEventListener('click', () => {
            floatWindow.classList.toggle('active');
        });

        modalBack.addEventListener('click', () => {
            floatWindow.classList.remove('active');
        });

        // 自动更新逻辑（修复加载卡住问题）
        const container = document.getElementById('latest-html-container');
        const notice = document.getElementById('update-notice');
        const RENDER_DOMAIN = 'https://auto-update-z5j4.onrender.com';

        // 主动请求最新HTML（页面加载时立即执行）
        function fetchLatestHtml() {
            fetch(`${RENDER_DOMAIN}/get-latest-html`)
                .then(res => res.json())
                .then(data => {
                    if (data.content) {
                        container.innerHTML = data.content;
                    }
                })
                .catch(err => {
                    console.error('获取最新内容失败:', err);
                });
        }

        // WebSocket监听更新（增加重连和消息验证）
        function initWebSocket() {
            let ws = new WebSocket(`wss://${RENDER_DOMAIN}`);
            ws.onopen = () => {
                console.log('WebSocket连接成功');
                ws.send(JSON.stringify({ type: 'get_latest' })); // 主动请求最新内容
            };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'new_html' && data.content) {
                    container.innerHTML = data.content;
                    notice.style.display = 'block';
                    setTimeout(() => notice.style.display = 'none', 3000);
                }
            };
            ws.onclose = () => {
                console.log('WebSocket断开，5秒后重连');
                setTimeout(initWebSocket, 5000);
            };
            ws.onerror = (err) => {
                console.error('WebSocket错误:', err);
                setTimeout(initWebSocket, 5000);
            };
        }

        // 页面加载时初始化
        window.addEventListener('load', () => {
            fetchLatestHtml(); // 主动拉取最新内容
            initWebSocket();  // 启动WebSocket监听
        });
    </script>
</body>
</html>
