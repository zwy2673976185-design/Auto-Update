<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>悬浮窗+任意HTML自动更新（无提示版）</title>
    <style>
        /* 主体内容样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { 
            height: 100vh; 
            overflow: hidden; 
            touch-action: none; 
            position: relative; 
            background: #fff; 
        }
        #latest-html-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            z-index: 1;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* 悬浮窗样式（保留原有功能） */
        .float-btn {
            position: fixed;
            z-index: 1002;
            width: 60px;
            height: 60px; 
            border-radius: 0; 
            border: 2px solid #fff; 
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3); 
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-image: url(https://i.imgs.ovh/2025/09/28/75fraO.jpeg);
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 0;
            margin: 0;
            border: none;
        }
        .float-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        .float-window {
            position: fixed;
            z-index: 1001;
            width: 280px;
            height: 250px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .float-window.active {
            display: block;
            opacity: 1;
        }
        .window-header {
            padding: 12px 15px;
            background: #2563eb;
            color: white;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            -webkit-tap-highlight-color: transparent;
            height: 42px;
        }
        .modal-back {
            background: transparent;
            border: none;
            color: white;
            font-size: 15px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background 0.2s ease;
            display: none;
            -webkit-tap-highlight-color: transparent;
        }
        .modal-back:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .func-buttons {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: calc(250px - 42px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .func-btn {
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            background: #f8f9fa;
            font-size: 13px;
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            -webkit-tap-highlight-color: transparent;
            border: none;
        }
        .func-btn:hover, .func-btn:active {
            background: #f1f3f5;
            border-color: #ddd;
        }
        .btn-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        .content-panel {
            padding: 10px;
            max-height: calc(250px - 42px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: none;
        }
        .content-panel.active {
            display: block;
        }
        .user-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .user-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        .notice-item {
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .notice-item:last-child {
            border-bottom: none;
            margin-bottom: 3px;
            padding-bottom: 0;
        }
        .notice-title {
            font-weight: 500;
            margin-bottom: 3px;
            color: #2563eb;
        }
        .notice-time {
            font-size: 10px;
            color: #999;
            margin-bottom: 5px;
        }
        .empty-tip {
            font-size: 12px;
            color: #999;
            text-align: center;
            padding: 15px 0;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- 主体内容容器 -->
    <div id="latest-html-container">
        <div style="width:100%; height:100%; background:#f5f5f5;"></div>
    </div>

    <!-- 悬浮窗逻辑（保留原有功能） -->
    <script>
        (function() {
            if (window.floatingWindowInjected) return;
            window.floatingWindowInjected = true;

            const config = {
                floatBtnSize: 60,
                safeMargin: 20,
                defaultSafeBottom: 20,
                windowWidth: 280,
                windowHeight: 250
            };

            const utils = {
                formatTime: function(dateStr) {
                    try {
                        const date = new Date(dateStr);
                        return [
                            date.getFullYear(),
                            String(date.getMonth() + 1).padStart(2, '0'),
                            String(date.getDate()).padStart(2, '0')
                        ].join('-') + ' ' + [
                            String(date.getHours()).padStart(2, '0'),
                            String(date.getMinutes()).padStart(2, '0')
                        ].join(':');
                    } catch (err) {
                        return '时间格式错误';
                    }
                },
                getSafeBottom: function() {
                    const bodyStyle = getComputedStyle(document.body);
                    const paddingBottom = parseFloat(bodyStyle.paddingBottom);
                    return isNaN(paddingBottom) ? config.defaultSafeBottom : paddingBottom;
                },
                checkWindowBound: function(left, top) {
                    const windowWidth = document.documentElement.clientWidth;
                    const windowHeight = document.documentElement.clientHeight;
                    const safeBottom = utils.getSafeBottom();
                    const boundedLeft = Math.max(config.safeMargin, Math.min(left, windowWidth - config.windowWidth - config.safeMargin));
                    const boundedTop = Math.max(config.safeMargin, Math.min(top, windowHeight - config.windowHeight - safeBottom - config.safeMargin));
                    return { left: boundedLeft, top: boundedTop };
                },
                getDefaultWindowPos: function() {
                    const windowWidth = document.documentElement.clientWidth;
                    const windowHeight = document.documentElement.clientHeight;
                    const left = (windowWidth - config.windowWidth) / 2;
                    const top = (windowHeight - config.windowHeight) / 2;
                    return utils.checkWindowBound(left, top);
                }
            };

            function createFloatElements() {
                const floatBtn = document.createElement('button');
                floatBtn.className = 'float-btn';
                floatBtn.id = 'floatBtn';
                document.body.appendChild(floatBtn);

                const floatWindow = document.createElement('div');
                floatWindow.className = 'float-window';
                floatWindow.id = 'floatWindow';
                floatWindow.innerHTML = `
                    <div class="window-header" id="windowHeader">
                        功能面板
                        <button class="modal-back" id="modalBack">返回</button>
                    </div>
                    <div class="func-buttons" id="funcButtons">
                        <button class="func-btn" id="btnMy">
                            <span>我的</span>
                            <img src="https://img.icons8.com/ios-glyphs/30/666/user--v1.png" class="btn-icon" alt="我的">
                        </button>
                        <button class="func-btn" id="btnNotice">
                            <span>公告</span>
                        </button>
                        <button class="func-btn" id="btnContact">
                            <span>联系作者</span>
                            <img src="https://img.icons8.com/ios-glyphs/30/666/contact-card--v1.png" class="btn-icon" alt="联系作者">
                        </button>
                        <button class="func-btn" id="btnSetting">
                            <span>设置</span>
                            <img src="https://img.icons8.com/ios-glyphs/30/666/settings--v1.png" class="btn-icon" alt="设置">
                        </button>
                    </div>
                    <div class="content-panel" id="panelMy">
                        <div class="user-name">用一生找寻</div>
                        <div class="user-desc">当前功能待后续开发，暂显示用户名<br>后续可添加头像、个人信息、功能开关等内容</div>
                    </div>
                    <div class="content-panel" id="panelNotice">
                        <div class="notice-item">
                            <div class="notice-title">V1.0 功能更新公告</div>
                            <div class="notice-time">${utils.formatTime(new Date().toISOString())}</div>
                            <div>1. 支持任意HTML文件加载与执行；<br>2. 自动修复资源路径，确保图片、脚本正常加载；<br>3. 无更新提示，界面更简洁。</div>
                        </div>
                    </div>
                    <div class="content-panel" id="panelSetting">
                        <div class="empty-tip">设置功能待开发<br>敬请期待后续更新～</div>
                    </div>
                `;
                document.body.appendChild(floatWindow);

                return { floatBtn, floatWindow };
            }

            function initFloatFunctions(elements) {
                const { floatBtn, floatWindow } = elements;
                const modalBack = document.getElementById('modalBack');
                const windowHeader = document.getElementById('windowHeader');
                const funcButtons = document.getElementById('funcButtons');
                const btnMy = document.getElementById('btnMy');
                const btnNotice = document.getElementById('btnNotice');
                const btnContact = document.getElementById('btnContact');
                const btnSetting = document.getElementById('btnSetting');
                const panelMy = document.getElementById('panelMy');
                const panelNotice = document.getElementById('panelNotice');
                const panelSetting = document.getElementById('panelSetting');

                let btnIsDragging = false;
                let btnDragStart = 0;
                let btnStartX = 0;
                let btnStartY = 0;
                let btnOffsetX = 0;
                let btnOffsetY = 0;
                let winIsDragging = false;
                let winDragStart = 0;
                let winStartX = 0;
                let winStartY = 0;
                let winOffsetX = 0;
                let winOffsetY = 0;
                let isInMainPanel = true; 
                let currentWindowPos = utils.getDefaultWindowPos();

                function initBtnPosition() {
                    const windowWidth = document.documentElement.clientWidth;
                    const windowHeight = document.documentElement.clientHeight;
                    const safeBottom = utils.getSafeBottom();
                    const btnSize = config.floatBtnSize;
                    floatBtn.style.left = `${windowWidth - btnSize - config.safeMargin}px`;
                    floatBtn.style.top = `${windowHeight - btnSize - safeBottom - config.safeMargin}px`;
                    floatBtn.style.bottom = 'auto';
                    floatBtn.style.right = 'auto';
                }

                function positionWindow() {
                    const boundedPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    currentWindowPos = boundedPos;
                    floatWindow.style.left = `${boundedPos.left}px`;
                    floatWindow.style.top = `${boundedPos.top}px`;
                }

                function switchContentPanel(targetPanelId) {
                    funcButtons.style.display = 'none';
                    panelMy.classList.remove('active');
                    panelNotice.classList.remove('active');
                    panelSetting.classList.remove('active');
                    document.getElementById(targetPanelId).classList.add('active');
                    modalBack.style.display = 'block';
                    isInMainPanel = false;
                }

                function backToMainPanel() {
                    funcButtons.style.display = 'flex';
                    panelMy.classList.remove('active');
                    panelNotice.classList.remove('active');
                    panelSetting.classList.remove('active');
                    modalBack.style.display = 'none';
                    isInMainPanel = true;
                }

                floatBtn.addEventListener('click', () => {
                    if (!btnIsDragging) {
                        floatWindow.classList.toggle('active');
                        if (floatWindow.classList.contains('active')) positionWindow();
                    }
                });

                modalBack.addEventListener('click', backToMainPanel);

                btnMy.addEventListener('click', () => switchContentPanel('panelMy'));
                btnNotice.addEventListener('click', () => switchContentPanel('panelNotice'));
                btnContact.addEventListener('click', () => window.open('https://qzone.qq.com/2673976185', '_blank'));
                btnSetting.addEventListener('click', () => switchContentPanel('panelSetting'));

                floatBtn.addEventListener('touchstart', (e) => {
                    btnDragStart = Date.now();
                    const touch = e.touches[0];
                    btnStartX = touch.clientX;
                    btnStartY = touch.clientY;
                    const btnRect = floatBtn.getBoundingClientRect();
                    btnOffsetX = btnRect.left;
                    btnOffsetY = btnRect.top;
                    btnIsDragging = false;
                }, { passive: true });

                floatBtn.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - btnStartX);
                    const moveY = Math.abs(touch.clientY - btnStartY);
                    if (moveX > 5 || moveY > 5 || Date.now() - btnDragStart > 150) {
                        btnIsDragging = true;
                        const newLeft = btnOffsetX + (touch.clientX - btnStartX);
                        const newTop = btnOffsetY + (touch.clientY - btnStartY);
                        const windowWidth = document.documentElement.clientWidth;
                        const windowHeight = document.documentElement.clientHeight;
                        const btnSize = config.floatBtnSize;
                        const safeBottom = utils.getSafeBottom();
                        const boundedLeft = Math.max(config.safeMargin, Math.min(newLeft, windowWidth - btnSize - config.safeMargin));
                        const boundedTop = Math.max(config.safeMargin, Math.min(newTop, windowHeight - btnSize - safeBottom - config.safeMargin));
                        floatBtn.style.left = `${boundedLeft}px`;
                        floatBtn.style.top = `${boundedTop}px`;
                    }
                }, { passive: false });

                windowHeader.addEventListener('touchstart', (e) => {
                    if (!floatWindow.classList.contains('active')) return;
                    winDragStart = Date.now();
                    const touch = e.touches[0];
                    winStartX = touch.clientX;
                    winStartY = touch.clientY;
                    const winRect = floatWindow.getBoundingClientRect();
                    winOffsetX = winRect.left;
                    winOffsetY = winRect.top;
                    winIsDragging = false;
                }, { passive: true });

                windowHeader.addEventListener('touchmove', (e) => {
                    if (!floatWindow.classList.contains('active')) return;
                    const touch = e.touches[0];
                    const moveX = Math.abs(touch.clientX - winStartX);
                    const moveY = Math.abs(touch.clientY - winStartY);
                    if (moveX > 5 || moveY > 5 || Date.now() - winDragStart > 150) {
                        winIsDragging = true;
                        const newLeft = winOffsetX + (touch.clientX - winStartX);
                        const newTop = winOffsetY + (touch.clientY - winStartY);
                        const boundedPos = utils.checkWindowBound(newLeft, newTop);
                        currentWindowPos = boundedPos;
                        floatWindow.style.left = `${boundedPos.left}px`;
                        floatWindow.style.top = `${boundedPos.top}px`;
                    }
                }, { passive: false });

                window.addEventListener('load', initBtnPosition);
                window.addEventListener('resize', () => {
                    initBtnPosition();
                    if (floatWindow.classList.contains('active')) positionWindow();
                });

                backToMainPanel();
            }

            function initFloatingWindow() {
                try {
                    const elements = createFloatElements();
                    initFloatFunctions(elements);
                    console.log('悬浮窗初始化完成（功能正常）');
                } catch (err) {
                    console.error('悬浮窗加载报错：', err);
                }
            }

            window.addEventListener('load', initFloatingWindow);
        })();
    </script>

    <!-- 任意HTML文件加载逻辑（无提示版） -->
    <script>
        const container = document.getElementById('latest-html-container');
        // GitHub仓库信息（替换为你的仓库）
        const GITHUB_REPO = 'zwy2673976185-design/Auto-Update'; 
        const GITHUB_TOKEN = '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'; // 你的GitHub令牌
        const RENDER_DOMAIN = 'auto-update-z5j4.onrender.com';
        const WS_URL = `wss://${RENDER_DOMAIN}`;

        // 修复资源路径（将相对路径转为GitHub绝对路径）
        function fixResourcePaths(htmlContent) {
            // 修复图片路径
            htmlContent = htmlContent.replace(/src="([^"]+)"/g, (match, src) => {
                if (src.startsWith('http://') || src.startsWith('https://')) return match;
                return `src="https://raw.githubusercontent.com/${GITHUB_REPO}/main/${src}"`;
            });
            // 修复样式路径
            htmlContent = htmlContent.replace(/href="([^"]+)"/g, (match, href) => {
                if (href.startsWith('http://') || href.startsWith('https://')) return match;
                return `href="https://raw.githubusercontent.com/${GITHUB_REPO}/main/${href}"`;
            });
            // 修复脚本路径
            htmlContent = htmlContent.replace(/src="([^"]+)"/g, (match, src) => {
                if (src.startsWith('http://') || src.startsWith('https://')) return match;
                return `src="https://raw.githubusercontent.com/${GITHUB_REPO}/main/${src}"`;
            });
            return htmlContent;
        }

        // 渲染HTML并执行所有脚本
        function renderHtml(htmlContent) {
            try {
                htmlContent = fixResourcePaths(htmlContent);
                container.innerHTML = htmlContent;
                // 执行所有脚本（包括内联和外部）
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    // 复制所有属性（如src、type、defer、async）
                    Array.from(script.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.textContent = script.textContent;
                    script.parentNode.replaceChild(newScript, script);
                });
            } catch (err) {
                console.error('HTML渲染失败：', err);
            }
        }

        // 获取GitHub仓库中最新的HTML文件
        function fetchLatestHtmlFromGitHub() {
            fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents`, {
                headers: {
                    Authorization: `token ${GITHUB_TOKEN}`,
                    Accept: 'application/vnd.github.v3+json'
                }
            })
            .then(res => res.json())
            .then(files => {
                // 筛选出所有HTML文件
                const htmlFiles = files.filter(file => file.name.endsWith('.html'));
                if (htmlFiles.length === 0) {
                    return;
                }
                // 加载最新的HTML文件（按更新时间排序）
                htmlFiles.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                const latestHtmlFile = htmlFiles[0];
                fetch(latestHtmlFile.download_url)
                    .then(res => res.text())
                    .then(htmlContent => {
                        renderHtml(htmlContent);
                        localStorage.setItem('latest_html_content', htmlContent);
                    })
                    .catch(err => console.error(err));
            })
            .catch(err => console.error(err));
        }

        // WebSocket监听更新
        function initWebSocket() {
            const ws = new WebSocket(WS_URL);
            ws.onopen = () => console.log('自动更新连接成功，等待新文件上传');
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'new_html') {
                    fetchLatestHtmlFromGitHub();
                }
            };
            ws.onclose = () => setTimeout(initWebSocket, 5000);
        }

        // 初始化
        window.addEventListener('load', () => {
            const cachedHtml = localStorage.getItem('latest_html_content');
            if (cachedHtml) {
                renderHtml(cachedHtml);
            } else {
                fetchLatestHtmlFromGitHub();
            }
            initWebSocket();
        });
    </script>
</body>
</html>
